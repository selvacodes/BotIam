import G, { AxiosError } from 'axios';
import K from 'zod';

function D(e,o){let t={...e};for(let i of o)delete t[i];return t}function w(e){return e.charAt(0).toUpperCase()+e.slice(1)}var T=/:([a-zA-Z_][a-zA-Z0-9_]*)/g;function q(e){let o=e.url,t=e.params;return t&&(o=o.replace(T,(i,n)=>n in t?`${t[n]}`:i)),o}function m(e,o,t){return e.find(i=>i.method===o&&i.path===t)}function U(e,o){return e.find(t=>t.alias===o)}function M(e,o){var i,n;let t=(i=e.errors)==null?void 0:i.filter(s=>s.status===o.response.status);return t&&t.length>0?t:(n=e.errors)==null?void 0:n.filter(s=>s.status==="default")}function $(e,o,t,i){let n=m(e,o,t);return n&&i.config&&i.config.url&&n.method===i.config.method&&k(n.path,i.config.url)?M(n,i):void 0}function O(e,o,t){let i=U(e,o);return i&&t.config&&t.config.url&&i.method===t.config.method&&k(i.path,t.config.url)?M(i,t):void 0}function k(e,o){return new RegExp(`^${e.replace(T,()=>"([^/]+)")}$`).test(o)}function b(e){let o=new FormData;for(let t in e)o.append(t,e[t]);return {data:o}}var u=class extends Error{constructor(t,i,n,s){super(t);this.config=i;this.data=n;this.cause=s;}};var F={name:"form-data",request:async(e,o)=>{if(typeof o.data!="object"||Array.isArray(o.data))throw new u("Zodios: multipart/form-data body must be an object",o);let t=b(o.data);return {...o,data:t.data,headers:{...o.headers,...t.headers}}}};function x(){return F}var S={name:"form-url",request:async(e,o)=>{if(typeof o.data!="object"||Array.isArray(o.data))throw new u("Zodios: application/x-www-form-urlencoded body must be an object",o);return {...o,data:new URLSearchParams(o.data).toString(),headers:{...o.headers,"Content-Type":"application/x-www-form-urlencoded"}}}};function E(){return S}function P(e,o){return {request:async(t,i)=>({...i,headers:{...i.headers,[e]:o}})}}function v(e){return [!0,"response","all"].includes(e)}function C(e){return [!0,"request","all"].includes(e)}function R({validate:e,transform:o,sendDefaults:t}){return {name:"zod-validation",request:C(e)?async(i,n)=>{let s=m(i,n.method,n.url);if(!s)throw new Error(`No endpoint found for ${n.method} ${n.url}`);let{parameters:a}=s;if(!a)return n;let d={...n,queries:{...n.queries},headers:{...n.headers},params:{...n.params}},c={Query:p=>{var r;return (r=d.queries)==null?void 0:r[p]},Body:p=>d.data,Header:p=>{var r;return (r=d.headers)==null?void 0:r[p]},Path:p=>{var r;return (r=d.params)==null?void 0:r[p]}},h={Query:(p,r)=>d.queries[p]=r,Body:(p,r)=>d.data=r,Header:(p,r)=>d.headers[p]=r,Path:(p,r)=>d.params[p]=r},N=C(o);for(let p of a){let{name:r,schema:j,type:Z}=p,g=c[Z](r);if(t||g!==void 0){let A=await j.safeParseAsync(g);if(!A.success)throw new u(`Zodios: Invalid ${Z} parameter '${r}'`,n,g,A.error);N&&h[Z](r,A.data);}}return d}:void 0,response:v(e)?async(i,n,s)=>{var d,c;let a=m(i,n.method,n.url);if(!a)throw new Error(`No endpoint found for ${n.method} ${n.url}`);if((c=(d=s.headers)==null?void 0:d["content-type"])!=null&&c.includes("application/json")){let h=await a.response.safeParseAsync(s.data);if(!h.success)throw new u(`Zodios: Invalid response from endpoint '${a.method} ${a.path}'
status: ${s.status} ${s.statusText}
cause:
${h.error.message}
received:
${JSON.stringify(s.data,null,2)}`,n,s.data,h.error);v(o)&&(s.data=h.data);}return s}:void 0}}var l=class{constructor(o,t){this.plugins=[];this.key=`${o}-${t}`;}indexOf(o){return this.plugins.findIndex(t=>(t==null?void 0:t.name)===o)}use(o){if(o.name){let t=this.indexOf(o.name);if(t!==-1)return this.plugins[t]=o,{key:this.key,value:t}}return this.plugins.push(o),{key:this.key,value:this.plugins.length-1}}eject(o){if(typeof o=="string"){let t=this.indexOf(o);if(t===-1)throw new Error(`Plugin with name '${o}' not found`);this.plugins[t]=void 0;}else {if(o.key!==this.key)throw new Error(`Plugin with key '${o.key}' is not registered for endpoint '${this.key}'`);this.plugins[o.value]=void 0;}}async interceptRequest(o,t){let i=t;for(let n of this.plugins)n!=null&&n.request&&(i=await n.request(o,i));return i}async interceptResponse(o,t,i){let n=i;for(let s=this.plugins.length-1;s>=0;s--){let a=this.plugins[s];a&&(n=n.then(a!=null&&a.response?d=>a.response(o,t,d):void 0,a!=null&&a.error?d=>a.error(o,t,d):void 0));}return n}count(){return this.plugins.reduce((o,t)=>t?o+1:o,0)}};function y(e){let o=new Set;for(let t of e){let i=`${t.method} ${t.path}`;if(o.has(i))throw new Error(`Zodios: Duplicate path '${i}'`);o.add(i);}}function I(e){return y(e),e}function L(e){return e}function _(e){return e}function H(e){return e}var f=class{constructor(o){this.api=o;}addEndpoint(o){return new f([...this.api,o])}build(){return y(this.api),this.api}};function Q(e){return new f([e])}function V(e,o){let t=w(e);return I([{method:"get",path:`/${e}s`,alias:`get${t}s`,description:`Get all ${e}s`,response:K.array(o)},{method:"get",path:`/${e}s/:id`,alias:`get${t}`,description:`Get a ${e}`,response:o},{method:"post",path:`/${e}s`,alias:`create${t}`,description:`Create a ${e}`,parameters:[{name:"body",type:"Body",description:"The object to create",schema:o.partial()}],response:o},{method:"put",path:`/${e}s/:id`,alias:`update${t}`,description:`Update a ${e}`,parameters:[{name:"body",type:"Body",description:"The object to update",schema:o}],response:o},{method:"patch",path:`/${e}s/:id`,alias:`patch${t}`,description:`Patch a ${e}`,parameters:[{name:"body",type:"Body",description:"The object to patch",schema:o.partial()}],response:o},{method:"delete",path:`/${e}s/:id`,alias:`delete${t}`,description:`Delete a ${e}`,response:o}])}var B=class{constructor(o,t,i){this.endpointPlugins=new Map;let n;if(!o)throw Array.isArray(t)?new Error("Zodios: missing base url"):new Error("Zodios: missing api description");let s;if(typeof o=="string"&&Array.isArray(t))s=o,this.api=t,n=i||{};else if(Array.isArray(o)&&!Array.isArray(t))this.api=o,n=t||{};else throw new Error("Zodios: api must be an array");y(this.api),this.options={validate:!0,transform:!0,sendDefaults:!1,...n},this.options.axiosInstance?this.axiosInstance=this.options.axiosInstance:this.axiosInstance=G.create({...this.options.axiosConfig}),s&&(this.axiosInstance.defaults.baseURL=s),this.injectAliasEndpoints(),this.initPlugins(),[!0,"all","request","response"].includes(this.options.validate)&&this.use(R(this.options));}initPlugins(){this.endpointPlugins.set("any-any",new l("any","any")),this.api.forEach(o=>{let t=new l(o.method,o.path);switch(o.requestFormat){case"binary":t.use(P("Content-Type","application/octet-stream"));break;case"form-data":t.use(x());break;case"form-url":t.use(E());break;case"text":t.use(P("Content-Type","text/plain"));break}this.endpointPlugins.set(`${o.method}-${o.path}`,t);});}getAnyEndpointPlugins(){return this.endpointPlugins.get("any-any")}findAliasEndpointPlugins(o){let t=this.api.find(i=>i.alias===o);if(t)return this.endpointPlugins.get(`${t.method}-${t.path}`)}findEnpointPlugins(o,t){return this.endpointPlugins.get(`${o}-${t}`)}get baseURL(){return this.axiosInstance.defaults.baseURL}get axios(){return this.axiosInstance}use(...o){if(typeof o[0]=="object")return this.getAnyEndpointPlugins().use(o[0]);if(typeof o[0]=="string"&&typeof o[1]=="object"){let t=this.findAliasEndpointPlugins(o[0]);if(!t)throw new Error(`Zodios: no alias '${o[0]}' found to register plugin`);return t.use(o[1])}else if(typeof o[0]=="string"&&typeof o[1]=="string"&&typeof o[2]=="object"){let t=this.findEnpointPlugins(o[0],o[1]);if(!t)throw new Error(`Zodios: no endpoint '${o[0]} ${o[1]}' found to register plugin`);return t.use(o[2])}throw new Error("Zodios: invalid plugin registration")}eject(o){var t;if(typeof o=="string"){this.getAnyEndpointPlugins().eject(o);return}(t=this.endpointPlugins.get(o.key))==null||t.eject(o);}injectAliasEndpoints(){this.api.forEach(o=>{o.alias&&(["post","put","patch","delete"].includes(o.method)?this[o.alias]=(t,i)=>this.request({...i,method:o.method,url:o.path,data:t}):this[o.alias]=t=>this.request({...t,method:o.method,url:o.path}));});}async request(o){let t=o,i=this.getAnyEndpointPlugins(),n=this.findEnpointPlugins(t.method,t.url);t=await i.interceptRequest(this.api,t),n&&(t=await n.interceptRequest(this.api,t));let s=this.axiosInstance.request({...D(t,["params","queries"]),url:q(t),params:t.queries});return n&&(s=n.interceptResponse(this.api,t,s)),s=i.interceptResponse(this.api,t,s),(await s).data}async get(o,...[t]){return this.request({...t,method:"get",url:o})}async post(o,t,...[i]){return this.request({...i,method:"post",url:o,data:t})}async put(o,t,...[i]){return this.request({...i,method:"put",url:o,data:t})}async patch(o,t,...[i]){return this.request({...i,method:"patch",url:o,data:t})}async delete(o,t,...[i]){return this.request({...i,method:"delete",url:o,data:t})}},J=B;function z(e,o){if(e instanceof AxiosError||e&&typeof e=="object"&&"isAxiosError"in e){let t=e;if(t.response){let i=o(t);if(i)return i.some(n=>n.schema.safeParse(t.response.data).success)}}return !1}function X(e,o,t,i){return z(i,n=>$(e,o,t,n))}function Y(e,o,t){return z(t,i=>O(e,o,i))}

export { J as Zodios, u as ZodiosError, Q as apiBuilder, y as checkApi, x as formDataPlugin, E as formURLPlugin, P as headerPlugin, Y as isErrorFromAlias, X as isErrorFromPath, I as makeApi, V as makeCrudApi, H as makeEndpoint, _ as makeErrors, L as makeParameters, R as zodValidationPlugin };
